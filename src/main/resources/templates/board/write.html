<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>게시글 상세</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
</head>
<body>
<h1>게시글 상세보기</h1>

<form id="boardForm" method="post" action="/board/insertBoard">
    <table width="90%">
<!--        <tr width="90%">
            <td align="center">작성자</td>
            <td width="50%" th:if="${board.user_id}" th:text="${board.user_id}">작성자</td>
            &lt;!&ndash; <td width="50%">${user.username}</td> &ndash;&gt;
&lt;!&ndash;            <td width="50%" th:text="${board.user_id}">사용자</td>&ndash;&gt;
        </tr>-->
        <tr>
            <td align="center">제목</td>
            <td><input type="text" name="title" style="width: 95%;" th:value="${board.title}"></td>
        </tr>
        <tr>
            <td align="center">내용</td>
            <td><textarea name="content" style="width: 95%;height: 200px;" th:text="${board.content}"></textarea></td>
        </tr>
                <tr>
                    <td align="center">이미지 등록</td>
                    <td>
                        <input type="file" name="files" id="files" multiple="multiple" onchange="uploadFile(this)">
                        <div id="uploadDiv">
                            <div th:each="file, status : ${getFile}" class="uploadResult">
                                <span th:text="${status.index + 1} + '. '">1. </span>
                                <a th:href="@{/downloadFile(uuid=${file.uuid}, fileName=${file.fileName})}" th:text="${file.fileName}" download>파일명</a>
                                <input type="hidden" name="uuids" th:value="${file.getUuid()}">
                                <input type="hidden" name="fileNames" th:value="${file.getFileName()}">
                                <label class="delBtn">◀ 삭제</label>
                            </div>
                        </div>
                    </td>
                    <br><br><br>
                </tr>
        <tr>
            <td colspan="2" align="center">
                <input type="hidden" name="id" th:value="${board.id}">
                <button type="submit">등록</button>
                <button type="button" onclick="history.back()">뒤로가기</button>
                <button type="button" th:if="${board.id}" onclick="deleteBoard()">삭제</button>
            </td>
        </tr>
    </table>
</form>

<script>
    // delBtn 개별 삭제 버튼
    $(function () {
        delBtnFile();
    });

    function delBtnFile() {
        $(".delBtn").on("click", function () {
            $(this).parent().remove();
            stCnt();
        });
    }

    // status.count ajax사용시 다시 그려주기
    function stCnt() {
        $('.uploadResult').each(function (index, item) {
            $(this).children('span').html(index + 1 + '. ');
        });
    }

    // ajax 첨부파일 업로드
    function uploadFile(obj) {
        let files = obj.files;
        let formData = new FormData();

        for (let i = 0; i < files.length; i++) {
            formData.append("files", files[i]);
        }

        $.ajax({
            type: 'post',
            enctype: 'multipart/form-data',
            url: '/ajaxFile',
            data: formData,
            processData: false,
            contentType: false,
            cache: false,  // 캐시 방지
            success: function (data) {
                console.log(data);
                let result = "";
                let cnt = $('.uploadResult').length;
                for (let i = 0; i < data.length; i++) {
                    result += '<div class="uploadResult">';
                    result += '<span>' + (cnt + i + 1) + '. </span><a href="/downloadFile?uuid=' + data[i].uuid + '&fileName=' + data[i].fileNames + '" download>' + data[i].fileNames + '</a>';
                    result += '<input type="hidden" name="uuids" value="' + data[i].uuid + '">';
                    result += '<input type="hidden" name="fileNames" value="' + data[i].fileNames + '">';
                    result += '<input type="hidden" name="contentTypes" value="' + data[i].contentType + '">';
                    result += '<label type="button" class="delBtn"> ◀ 삭제</label>';
                    result += '</div>';
                }
                $('#uploadDiv').append(result);
                delBtnFile();
            }
        });
    }

    // 글 삭제
    function deleteBoard() {
        const id = document.getElementsByName("id")[0].value;
        if (confirm("정말 삭제하시겠습니까?")) {
            fetch(`/board/delete/${id}`, {
                method: 'DELETE'
            })
                .then(response => {
                    console.log(response); // 서버 응답 확인
                    if (response.ok) {
                        alert("삭제되었습니다.");
                        location.href = "/board";
                    } else {
                        alert("삭제에 실패하였습니다.");
                    }
                })
                .catch(error => {
                    console.error("Error:", error);
                    alert("삭제 중 오류가 발생하였습니다.");
                });
        }
    }
</script>
</body>
</html>